# Default consumables
potion=tempered_potion_3
flask=flask_of_alchemical_chaos_3
food=feast_of_the_midnight_masquerade
augmentation=crystallized
temporary_enchant=main_hand:algari_mana_oil_3

# Executed before combat begins. Accepts non-harmful actions only.
actions.precombat=variable,name=no_cd_talent,value=!talent.celestial_alignment&!talent.incarnation_chosen_of_elune|druid.no_cds
actions.precombat+=/variable,name=on_use_trinket,value=0
actions.precombat+=/variable,name=on_use_trinket,op=add,value=trinket.1.has_use_buff
actions.precombat+=/variable,name=on_use_trinket,op=add,value=(trinket.2.has_use_buff)*2
actions.precombat+=/moonkin_form
actions.precombat+=/wrath
actions.precombat+=/wrath
actions.precombat+=/starfire,if=!talent.stellar_flare
actions.precombat+=/stellar_flare

# Executed every time the actor is available.
actions=variable,name=passive_asp,value=6%spell_haste+talent.natures_balance+((talent.bounteous_bloom&buff.bounteous_bloom.up)*15)+talent.orbit_breaker*dot.moonfire.ticking*(buff.orbit_breaker.stack>(27-2*buff.solstice.up))*24
actions+=/variable,name=ca_effective_cd,value=cooldown.ca_inc.remains<?cooldown.force_of_nature.remains
actions+=/variable,name=pre_cd_condition,value=(!talent.whirling_stars|!talent.convoke_the_spirits|cooldown.convoke_the_spirits.remains<gcd.max*2|fight_remains<cooldown.convoke_the_spirits.remains+3|cooldown.convoke_the_spirits.remains>cooldown.ca_inc.full_recharge_time+15*talent.control_of_the_dream)&(variable.on_use_trinket=0|(variable.on_use_trinket=1|variable.on_use_trinket=3)&(trinket.1.cooldown.remains>cooldown.ca_inc.full_recharge_time+(15*talent.control_of_the_dream)|!talent.convoke_the_spirits&hero_tree.elunes_chosen&(trinket.1.cooldown.duration<=100&trinket.1.cooldown.remains>cooldown.ca_inc.full_recharge_time-cooldown.ca_inc.duration|trinket.1.cooldown.duration>=100&cooldown.ca_inc.charges_fractional=1&(trinket.1.cooldown.duration>?cooldown.ca_inc.full_recharge_time))|talent.convoke_the_spirits&(cooldown.convoke_the_spirits.remains<3&(ceil((fight_remains-10)%cooldown.convoke_the_spirits.duration)>ceil((fight_remains-trinket.1.cooldown.remains-10)%cooldown.convoke_the_spirits.duration))|cooldown.convoke_the_spirits.remains>trinket.1.cooldown.remains&cooldown.ca_inc.full_recharge_time-cooldown.ca_inc.duration<trinket.1.cooldown.remains+15)|trinket.1.cooldown.remains+6>fight_remains|trinket.1.cooldown.ready)|variable.on_use_trinket=2&(trinket.2.cooldown.remains>cooldown.ca_inc.full_recharge_time+(15*talent.control_of_the_dream)|!talent.convoke_the_spirits&hero_tree.elunes_chosen&(trinket.2.cooldown.duration<=100&trinket.2.cooldown.remains>cooldown.ca_inc.full_recharge_time-cooldown.ca_inc.duration|trinket.2.cooldown.duration>=100&cooldown.ca_inc.charges_fractional=1&(trinket.2.cooldown.duration>?cooldown.ca_inc.full_recharge_time))|talent.convoke_the_spirits&(cooldown.convoke_the_spirits.remains<3&(ceil((fight_remains-10)%cooldown.convoke_the_spirits.duration)>ceil((fight_remains-trinket.2.cooldown.remains-10)%cooldown.convoke_the_spirits.duration))|cooldown.convoke_the_spirits.remains>trinket.2.cooldown.remains&cooldown.ca_inc.full_recharge_time-cooldown.ca_inc.duration<trinket.2.cooldown.remains+15)|trinket.2.cooldown.remains+6>fight_remains|trinket.2.cooldown.ready))&cooldown.ca_inc.remains<gcd.max&!buff.ca_inc.up
actions+=/variable,name=cd_condition,value=variable.pre_cd_condition&(fight_remains<(15+5*talent.incarnation_chosen_of_elune)*(1-talent.whirling_stars*0.2)|target.time_to_die>10&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up))
actions+=/variable,name=convoke_condition,value=fight_remains<4+gcd.max|(buff.ca_inc.up|cooldown.ca_inc.remains>40)&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains>15)
actions+=/variable,name=eclipse_remains,value=buff.eclipse_lunar.remains<?buff.eclipse_solar.remains
actions+=/variable,name=enter_lunar,value=talent.lunar_calling|spell_targets.starfire>3-(talent.umbral_intensity|talent.soul_of_the_forest)
actions+=/variable,name=boat_stacks,value=buff.balance_of_all_things_arcane.stack+buff.balance_of_all_things_nature.stack
actions+=/variable,name=tww3_keeper_4pc,value=hero_tree.keeper_of_the_grove&set_bonus.tww3_4pc
actions+=/variable,name=kotg_single_ca_condition,value=variable.tww3_keeper_4pc&!buff.ca_inc.up&cooldown.ca_inc.ready&((variable.on_use_trinket=1&(trinket.1.cooldown.ready|fight_remains<trinket.1.cooldown.remains)|variable.on_use_trinket=2&(trinket.2.cooldown.ready|fight_remains<trinket.2.cooldown.remains)|variable.on_use_trinket=0|variable.on_use_trinket=3&(trinket.1.cooldown.ready|trinket.2.cooldown.ready|fight_remains<(trinket.1.cooldown.remains>?trinket.2.cooldown.remains)))&(cooldown.convoke_the_spirits.remains<gcd.max*3-0.5|fight_remains<cooldown.convoke_the_spirits.remains|!talent.convoke_the_spirits)&(cooldown.force_of_nature.remains<gcd.max*2-0.3&!(fight_remains>cooldown.ca_inc.full_recharge_time+buff.ca_inc.duration*0.3+gcd.max&fight_remains<cooldown.force_of_nature.remains+cooldown.force_of_nature.duration+gcd.max*2))&(cooldown.ca_inc.full_recharge_time>20&fight_remains>(cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration-gcd.max*5*talent.control_of_the_dream<?105)+gcd.max*6+4+2|fight_remains<cooldown.ca_inc.full_recharge_time+buff.ca_inc.duration+gcd.max&!(fight_remains>cooldown.ca_inc.full_recharge_time+buff.ca_inc.duration*0.3+gcd.max&cooldown.ca_inc.full_recharge_time>cooldown.force_of_nature.remains+cooldown.force_of_nature.duration+gcd.max&fight_remains>cooldown.force_of_nature.remains+cooldown.force_of_nature.duration+buff.harmony_of_the_grove.duration+gcd.max)&!(!cooldown.potion.ready&fight_remains>cooldown.potion.remains+buff.harmony_of_the_grove.duration)|!cooldown.potion.ready&fight_remains<cooldown.ca_inc.full_recharge_time+cooldown.ca_inc.duration*2+buff.dryad.duration+2&fight_remains>(cooldown.potion.remains+4+buff.dryad.duration+2+gcd.max<?cooldown.ca_inc.full_recharge_time+cooldown.ca_inc.duration+buff.dryad.duration+2+gcd.max<?(cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration-gcd.max*5*talent.control_of_the_dream<?105)+gcd.max*6+4+buff.dryad.duration+2<?(variable.on_use_trinket=1)*trinket.1.cooldown.duration+(variable.on_use_trinket=2)*trinket.2.cooldown.duration+(variable.on_use_trinket=3)*(trinket.1.cooldown.duration>?trinket.2.cooldown.duration)+4+buff.dryad.duration+2+gcd.max))|fight_remains<buff.ca_inc.duration+gcd.max*(1+(dot.moonfire.remains<(3>?fight_remains)+dot.sunfire.remains<(buff.ca_inc.duration+gcd.max>?fight_remains)<?dot.sunfire.remains<(buff.ca_inc.duration>?fight_remains)+dot.moonfire.remains<(3+gcd.max>?fight_remains))))
actions+=/variable,name=kotg_double_ca_condition,value=variable.tww3_keeper_4pc&!buff.ca_inc.up&(variable.on_use_trinket=1&(trinket.1.cooldown.ready|trinket.1.proc.any_dps.up)|variable.on_use_trinket=2&(trinket.2.cooldown.ready|trinket.2.proc.any_dps.up)|variable.on_use_trinket=0|variable.on_use_trinket=3&(trinket.1.cooldown.ready|trinket.1.proc.any_dps.up|trinket.2.cooldown.ready|trinket.2.proc.any_dps.up))&(cooldown.convoke_the_spirits.remains<gcd.max*2-0.3|!talent.convoke_the_spirits)&(cooldown.ca_inc.full_recharge_time<4+gcd.max*3&(cooldown.force_of_nature.ready|buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains<gcd.max*3-0.5&fight_remains<cooldown.force_of_nature.remains+buff.dryad.duration+2+4+gcd.max*4)|(cooldown.ca_inc.full_recharge_time-gcd.max<?cooldown.force_of_nature.remains)<buff.dryad.duration&(fight_remains<cooldown.force_of_nature.remains+buff.dryad.duration+2+4+gcd.max*2|fight_remains<cooldown.ca_inc.full_recharge_time+buff.ca_inc.duration+gcd.max&fight_remains<cooldown.ca_inc.full_recharge_time-buff.dryad.duration-gcd.max))&!(!cooldown.potion.ready&fight_remains<cooldown.ca_inc.full_recharge_time+cooldown.ca_inc.duration*2+buff.dryad.duration+2+gcd.max&fight_remains>(cooldown.potion.remains+buff.dryad.duration+2+gcd.max<?buff.dryad.duration+2+4+gcd.max*6)&(fight_remains<cooldown.ca_inc.full_recharge_time+cooldown.ca_inc.duration+buff.dryad.duration+2+gcd.max|fight_remains>((cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration-gcd.max*5*talent.control_of_the_dream<?105)+gcd.max*6+4+buff.dryad.duration+2<?(variable.on_use_trinket=1)*trinket.1.cooldown.duration+(variable.on_use_trinket=2)*trinket.2.cooldown.duration+(variable.on_use_trinket=3)*(trinket.1.cooldown.duration>?trinket.2.cooldown.duration)+4+buff.dryad.duration+2+gcd.max)))
actions+=/variable,name=kotg_second_ca_condition,value=variable.tww3_keeper_4pc&buff.ca_inc.up&((buff.harmony_of_the_grove.up&(cooldown.convoke_the_spirits.remains>30|buff.harmony_of_the_grove.remains<gcd.max*2|buff.dryads_favor.up)&!(!cooldown.potion.ready&fight_remains<cooldown.ca_inc.full_recharge_time+cooldown.ca_inc.duration+buff.dryad.duration+2+gcd.max&fight_remains>(cooldown.potion.remains+buff.dryad.duration+2+gcd.max<?cooldown.ca_inc.full_recharge_time+buff.dryad.duration+2+gcd.max)&(fight_remains<cooldown.ca_inc.full_recharge_time+buff.dryad.duration+2+gcd.max|fight_remains>((cooldown.convoke_the_spirits.remains-gcd.max*5*talent.control_of_the_dream<?105)+gcd.max*6+4+buff.dryad.duration+2<?(variable.on_use_trinket=1)*trinket.1.cooldown.remains+(variable.on_use_trinket=2)*trinket.2.cooldown.remains+(variable.on_use_trinket=3)*(trinket.1.cooldown.remains>?trinket.2.cooldown.remains)+4+buff.dryad.duration+2+gcd.max))))|fight_remains<buff.dryad.duration+2+gcd.max)
actions+=/variable,name=kotg_inc_condition,value=variable.tww3_keeper_4pc&astral_power.deficit<=50&(variable.on_use_trinket=1&trinket.1.cooldown.ready|variable.on_use_trinket=2&trinket.2.cooldown.ready|variable.on_use_trinket=0|variable.on_use_trinket=3&(trinket.1.cooldown.ready|trinket.2.cooldown.ready)|(trinket.1.cooldown.remains>cooldown.force_of_nature.duration|trinket.2.cooldown.remains>cooldown.force_of_nature.duration)&cooldown.force_of_nature.remains<gcd.max*2)|fight_remains<(cooldown.ca_inc.full_recharge_time>?cooldown.force_of_nature.remains)
actions+=/variable,name=pool_for_cd,value=astral_power<(variable.kotg_single_ca_condition*action.starsurge.cost*2<?variable.kotg_double_ca_condition*(action.starsurge.cost*2-action.force_of_nature.energize_amount)<?(!buff.ca_inc.up&fight_remains>cooldown.ca_inc.remains+2+gcd.max&fight_remains<(fight_remains-cooldown.ca_inc.remains>?buff.ca_inc.duration)+5)*action.starsurge.cost*3<?(!buff.ca_inc.up&fight_remains>cooldown.ca_inc.full_recharge_time+2+gcd.max&fight_remains<(fight_remains-cooldown.ca_inc.full_recharge_time>?buff.ca_inc.duration)+4+8)*(action.starsurge.cost*3-action.force_of_nature.energize_amount*(cooldown.force_of_nature.ready)))
actions+=/variable,name=pool_in_ca,value=buff.dryad.up&fight_remains>buff.dryad.remains&cooldown.convoke_the_spirits.remains>buff.dryad.remains&(astral_power-action.starsurge.cost+(0<?floor((buff.dryad.remains+2-gcd.max*2-0.5)%action.wrath.execute_time))*action.wrath.energize_amount)<action.starsurge.cost*2
actions+=/use_item,name=imperfect_ascendancy_serum,if=dot.sunfire.remains>4&(dot.moonfire.remains>4|talent.treants_of_the_moon&(cooldown.force_of_nature.remains<3|buff.harmony_of_the_grove.up)&variable.ca_effective_cd<1|fight_remains<20|fight_remains<variable.ca_effective_cd&(buff.harmony_of_the_grove.up|cooldown.convoke_the_spirits.ready))&buff.spymasters_report.stack<=29
actions+=/variable,name=generic_trinket_condition,value=(buff.dryad.up|buff.ca_inc.up)|variable.no_cd_talent|fight_remains<variable.ca_effective_cd&(buff.harmony_of_the_grove.up|cooldown.convoke_the_spirits.ready)&!cooldown.ca_inc.ready|(buff.spymasters_report.stack+variable.ca_effective_cd%6)>29&variable.ca_effective_cd>20|variable.on_use_trinket=0
actions+=/use_item,slot=trinket1,if=!trinket.1.is.spymasters_web&!trinket.1.is.imperfect_ascendancy_serum&!trinket.1.is.treacherous_transmitter&!trinket.1.is.soulletting_ruby&(variable.on_use_trinket!=1&variable.on_use_trinket!=3&trinket.2.cooldown.remains>20|fight_remains<(20+20*(trinket.2.has_use&trinket.2.cooldown.remains<25))|variable.generic_trinket_condition)
actions+=/use_item,slot=trinket2,if=!trinket.2.is.spymasters_web&!trinket.2.is.imperfect_ascendancy_serum&!trinket.2.is.treacherous_transmitter&!trinket.2.is.soulletting_ruby&(variable.on_use_trinket<2&trinket.1.cooldown.remains>20|variable.on_use_trinket=3&trinket.1.cooldown.remains>20&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up|ceil((fight_remains-15)%trinket.2.cooldown.duration)>ceil((fight_remains-cooldown.force_of_nature.remains-15)%trinket.2.cooldown.duration))|fight_remains<(20+20*(trinket.1.has_use&trinket.1.cooldown.remains<25))|variable.generic_trinket_condition)
actions+=/use_items
actions+=/potion,if=fight_remains<=30
actions+=/invoke_external_buff,name=power_infusion,if=variable.cd_condition&!variable.tww3_keeper_4pc|variable.tww3_keeper_4pc&(variable.kotg_single_ca_condition|variable.kotg_double_ca_condition)
actions+=/berserking,if=variable.no_cd_talent|fight_remains<15
actions+=/run_action_list,name=kotg_st,if=variable.tww3_keeper_4pc&spell_targets=1
actions+=/run_action_list,name=st,if=!variable.tww3_keeper_4pc&spell_targets=1
actions+=/run_action_list,name=aoe,if=spell_targets>1

actions.aoe=starsurge,if=buff.dryads_favor.up
actions.aoe+=/wrath,if=variable.enter_lunar&eclipse.in_eclipse&variable.eclipse_remains<cast_time
actions.aoe+=/starfire,if=!variable.enter_lunar&eclipse.in_eclipse&variable.eclipse_remains<cast_time
actions.aoe+=/starfall,if=astral_power.deficit<=variable.passive_asp+6
actions.aoe+=/moonfire,target_if=refreshable&(target.time_to_die-remains)>6&(!talent.treants_of_the_moon|spell_targets-active_dot.moonfire_dmg>6|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up),if=fight_style.dungeonroute|fight_style.dungeonslice
actions.aoe+=/sunfire,target_if=refreshable&(target.time_to_die-remains)>6-(spell_targets%2)
actions.aoe+=/moonfire,target_if=refreshable&(target.time_to_die-remains)>6&(!talent.treants_of_the_moon|spell_targets-active_dot.moonfire_dmg>6|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up),if=!fight_style.dungeonroute&!fight_style.dungeonslice
actions.aoe+=/wrath,if=variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)&!variable.pre_cd_condition
actions.aoe+=/starfire,if=!variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)
actions.aoe+=/stellar_flare,target_if=refreshable&(target.time_to_die-remains-target>7+spell_targets),if=spell_targets<(11-talent.umbral_intensity.rank-(2*talent.astral_smolder)-talent.lunar_calling)
actions.aoe+=/force_of_nature,if=variable.pre_cd_condition|cooldown.ca_inc.full_recharge_time+5+15*talent.control_of_the_dream>cooldown&(!talent.convoke_the_spirits|cooldown.convoke_the_spirits.remains+10+15*talent.control_of_the_dream>cooldown|fight_remains<cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration+5)&(variable.on_use_trinket=0|(variable.on_use_trinket=1|variable.on_use_trinket=3)&(trinket.1.cooldown.remains>5+15*talent.control_of_the_dream|cooldown.ca_inc.remains>20|trinket.1.cooldown.ready)|variable.on_use_trinket=2&(trinket.2.cooldown.remains>5+15*talent.control_of_the_dream|cooldown.ca_inc.remains>20|trinket.2.cooldown.ready))&(fight_remains>cooldown+5|fight_remains<cooldown.ca_inc.remains+7)|talent.whirling_stars&talent.convoke_the_spirits&cooldown.convoke_the_spirits.remains>cooldown.force_of_nature.duration-10&fight_remains>cooldown.convoke_the_spirits.remains+6
actions.aoe+=/fury_of_elune,if=eclipse.in_eclipse
actions.aoe+=/call_action_list,name=pre_cd
actions.aoe+=/celestial_alignment,if=variable.cd_condition
actions.aoe+=/incarnation,if=variable.cd_condition
actions.aoe+=/warrior_of_elune,if=!talent.lunar_calling&buff.eclipse_solar.remains<7|talent.lunar_calling&!buff.dreamstate.up
actions.aoe+=/starfire,if=(!talent.lunar_calling&spell_targets.starfire=1)&(buff.eclipse_solar.up&buff.eclipse_solar.remains<action.starfire.cast_time|eclipse.in_none)
actions.aoe+=/starfall,if=buff.starweavers_warp.up|buff.touch_the_cosmos.up
actions.aoe+=/starsurge,if=buff.starweavers_weft.up
actions.aoe+=/starfall
actions.aoe+=/convoke_the_spirits,if=(!buff.dreamstate.up&!buff.umbral_embrace.up&spell_targets.starfire<7|spell_targets.starfire=1)&(fight_remains<5|(buff.ca_inc.up|cooldown.ca_inc.remains>40)&(!hero_tree.keeper_of_the_grove|buff.harmony_of_the_grove.up|cooldown.force_of_nature.remains>15))
actions.aoe+=/new_moon
actions.aoe+=/half_moon
actions.aoe+=/full_moon
actions.aoe+=/wild_mushroom,if=!prev_gcd.1.wild_mushroom&!dot.fungal_growth.ticking
actions.aoe+=/force_of_nature,if=!hero_tree.keeper_of_the_grove
actions.aoe+=/starfire,if=talent.lunar_calling|buff.eclipse_lunar.up&spell_targets.starfire>3-(talent.umbral_intensity|talent.soul_of_the_forest)
actions.aoe+=/wrath

actions.kotg_pre_cd=potion,if=buff.ca_inc.up
actions.kotg_pre_cd+=/use_items,if=buff.ca_inc.up|fight_remains<15
actions.kotg_pre_cd+=/fury_of_elune,if=!buff.ca_inc.up&(variable.kotg_single_ca_condition|variable.kotg_double_ca_condition)|cooldown.convoke_the_spirits.remains>cooldown.fury_of_elune.duration

actions.kotg_st=warrior_of_elune,if=variable.eclipse_remains<=7
actions.kotg_st+=/wait,if=!talent.incarnation_chosen_of_elune&buff.dryad.up&(buff.ca_inc.remains<(cooldown.ca_inc.remains>?gcd.max*2)|buff.dryad.remains<gcd.max&fight_remains>buff.dryad.remains&fight_remains<buff.dryad.remains+gcd.max|buff.dryad.remains<gcd.max&fight_remains>buff.dryad.remains+gcd.max&fight_remains<buff.dryad.remains+gcd.max*2),sec=buff.dryad.remains
actions.kotg_st+=/wrath,if=variable.enter_lunar&eclipse.in_eclipse&variable.eclipse_remains<cast_time|(variable.kotg_single_ca_condition|variable.kotg_double_ca_condition|variable.kotg_inc_condition)&buff.parting_skies.up&(variable.eclipse_remains<cast_time|eclipse.in_none)
actions.kotg_st+=/starfire,if=!variable.enter_lunar&eclipse.in_eclipse&variable.eclipse_remains<cast_time&!buff.dryads_favor.up&!(variable.kotg_single_ca_condition|variable.kotg_double_ca_condition|variable.kotg_second_ca_condition|variable.kotg_inc_condition)
actions.kotg_st+=/moonfire,target_if=(remains<(3>?fight_remains)&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up|variable.kotg_single_ca_condition))|!dot.moonfire.ticking
actions.kotg_st+=/sunfire,target_if=remains<(3>?fight_remains)|variable.kotg_single_ca_condition&remains<(buff.dryad.duration+2>?fight_remains)&(astral_power>=action.starsurge.cost*2-action.sunfire.energize_amount|fight_remains<buff.ca_inc.duration+gcd.max*2)|variable.kotg_double_ca_condition&!buff.harmony_of_the_grove.up&remains<(buff.harmony_of_the_grove.duration>?fight_remains)&(astral_power>=action.starsurge.cost*2-action.sunfire.energize_amount-action.force_of_nature.energize_amount*cooldown.force_of_nature.ready|fight_remains<buff.dryad.duration+2+4+gcd.max*5)&!buff.ca_inc.up
actions.kotg_st+=/call_action_list,name=kotg_pre_cd
actions.kotg_st+=/force_of_nature,if=variable.kotg_double_ca_condition&astral_power>=action.starsurge.cost*2-action.force_of_nature.energize_amount&!(buff.harmony_of_the_grove.duration<cooldown.ca_inc.full_recharge_time+gcd.max*2)
actions.kotg_st+=/celestial_alignment,if=variable.kotg_single_ca_condition&(astral_power>=action.starsurge.cost*2|fight_remains<buff.ca_inc.duration+gcd.max)
actions.kotg_st+=/celestial_alignment,if=variable.kotg_double_ca_condition&(astral_power>=action.starsurge.cost*2|fight_remains<buff.dryad.duration+2+4+gcd.max*3)
actions.kotg_st+=/force_of_nature,if=(buff.dryads_favor.up|cooldown.ca_inc.remains<gcd.max&fight_remains<buff.dryad.duration+2+gcd.max*2)&buff.ca_inc.up
actions.kotg_st+=/celestial_alignment,if=variable.kotg_second_ca_condition
actions.kotg_st+=/incarnation,if=variable.kotg_inc_condition
actions.kotg_st+=/starsurge,if=buff.dryads_favor.up&buff.ca_inc.up
actions.kotg_st+=/wrath,if=variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)
actions.kotg_st+=/starfire,if=!variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)
actions.kotg_st+=/stellar_flare,if=remains<=buff.ca_inc.duration&variable.pool_for_cd|remains<=buff.ca_inc.up&!buff.dryads_favor.up
actions.kotg_st+=/force_of_nature,if=buff.dryad.up&buff.harmony_of_the_grove.duration>(buff.dryad.remains+2>?cooldown.ca_inc.remains+gcd.max*2+0.5)
actions.kotg_st+=/force_of_nature,if=!buff.ca_inc.up&variable.boat_stacks>=8&fight_remains>=cooldown.convoke_the_spirits.duration+cooldown.convoke_the_spirits.remains+4+gcd.max&!((cooldown.force_of_nature.duration>cooldown.convoke_the_spirits.remains&fight_remains<(cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration-(cooldown.force_of_nature.duration+gcd.max*5)*talent.control_of_the_dream<?105)+cooldown.force_of_nature.duration+4+gcd.max*6)|(variable.on_use_trinket=1&fight_remains>trinket.1.cooldown.duration+trinket.1.cooldown.remains+4+buff.dryad.duration+2+gcd.max&cooldown.force_of_nature.duration>trinket.1.cooldown.remains&fight_remains<cooldown.force_of_nature.duration+trinket.1.cooldown.duration+4+buff.dryad.duration+2+gcd.max)|(variable.on_use_trinket=2&fight_remains>trinket.2.cooldown.duration+trinket.2.cooldown.remains+4+buff.dryad.duration+2+gcd.max&cooldown.force_of_nature.duration>trinket.2.cooldown.remains&fight_remains<cooldown.force_of_nature.duration+trinket.2.cooldown.duration+4+buff.dryad.duration+2+gcd.max))&!((cooldown.convoke_the_spirits.remains<?(variable.on_use_trinket=1)*trinket.1.cooldown.remains<?(variable.on_use_trinket=2)*trinket.2.cooldown.remains<?(variable.on_use_trinket=3)*(trinket.1.cooldown.remains>?trinket.2.cooldown.remains))<cooldown.force_of_nature.duration-(60-talent.early_spring*15)*0.5)
actions.kotg_st+=/force_of_nature,if=!buff.ca_inc.up&variable.boat_stacks>=8&fight_remains<cooldown.convoke_the_spirits.duration+cooldown.convoke_the_spirits.remains+4+gcd.max&!(fight_remains>cooldown.ca_inc.remains+buff.harmony_of_the_grove.duration*0.6+gcd.max&fight_remains<cooldown.force_of_nature.duration+buff.harmony_of_the_grove.duration*0.6+gcd.max*2)&!(fight_remains>cooldown.ca_inc.full_recharge_time+buff.dryad.duration+2+gcd.max&fight_remains<cooldown.force_of_nature.duration+buff.dryad.duration+2+gcd.max*2)&!(fight_remains<cooldown.force_of_nature.duration+gcd.max*2)
actions.kotg_st+=/force_of_nature,if=fight_remains<buff.harmony_of_the_grove.duration+gcd.max
actions.kotg_st+=/starsurge,if=buff.dryad.remains>buff.dryad.duration-gcd.max-0.3
actions.kotg_st+=/wrath,if=variable.pool_for_cd
actions.kotg_st+=/fury_of_elune,if=5+variable.passive_asp<astral_power.deficit&(cooldown.convoke_the_spirits.remains>buff.fury_of_elune.duration|!talent.convoke_the_spirits)|fight_remains<8+gcd.max
actions.kotg_st+=/starfall,if=buff.starweavers_warp.up
actions.kotg_st+=/starsurge,if=talent.starlord&buff.starlord.stack<3&!variable.pool_in_ca&!(variable.convoke_condition&cooldown.convoke_the_spirits.ready)
actions.kotg_st+=/sunfire,target_if=refreshable&remains<fight_remains
actions.kotg_st+=/moonfire,target_if=refreshable&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up)&remains<fight_remains
actions.kotg_st+=/starsurge,if=cooldown.convoke_the_spirits.remains<gcd.max*2&variable.convoke_condition&!(cooldown.ca_inc.remains<buff.dryad.remains&(buff.dryad.remains<4+gcd.max|fight_remains>cooldown.ca_inc.remains+buff.dryad.duration+2&fight_remains<4+buff.dryad.duration+2+gcd.max))&!(buff.harmony_of_the_grove.remains<4+gcd.max)&!(cooldown.ca_inc.remains<buff.harmony_of_the_grove.remains-gcd.max&buff.harmony_of_the_grove.remains<4+gcd.max*2)&!(fight_remains<4+gcd.max)&!(buff.ca_inc.remains<4+gcd.max)
actions.kotg_st+=/convoke_the_spirits,if=variable.convoke_condition&!(cooldown.ca_inc.remains<buff.dryad.remains&(buff.dryad.remains<4|fight_remains>cooldown.ca_inc.remains+buff.dryad.duration+2&fight_remains<4+buff.dryad.duration+2))
actions.kotg_st+=/stellar_flare,target_if=refreshable&(target.time_to_die-remains-target>7+spell_targets)&!buff.ca_inc.up
actions.kotg_st+=/starsurge,if=(buff.starlord.remains>4&variable.boat_stacks>=7|fight_remains<4)&!variable.pool_in_ca
actions.kotg_st+=/new_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&((buff.harmony_of_the_grove.up&!buff.ca_inc.up|buff.ca_inc.up&!cooldown.ca_inc.ready)|cooldown.new_moon.full_recharge_time<cooldown.convoke_the_spirits.remains)|fight_remains<20
actions.kotg_st+=/half_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&((buff.harmony_of_the_grove.up&!buff.ca_inc.up|buff.ca_inc.up&!cooldown.ca_inc.ready)|cooldown.new_moon.full_recharge_time<cooldown.convoke_the_spirits.remains)|fight_remains<20
actions.kotg_st+=/full_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&((buff.harmony_of_the_grove.up&!buff.ca_inc.up|buff.ca_inc.up&!cooldown.ca_inc.ready)|cooldown.new_moon.full_recharge_time<cooldown.convoke_the_spirits.remains)|fight_remains<20
actions.kotg_st+=/starsurge,if=buff.starweavers_weft.up|buff.touch_the_cosmos.up
actions.kotg_st+=/starsurge,if=(astral_power.deficit<variable.passive_asp+action.wrath.energize_amount+(action.starfire.energize_amount+variable.passive_asp)*(buff.eclipse_solar.remains<(gcd.max*2)))&!variable.pool_in_ca
actions.kotg_st+=/wild_mushroom,if=!prev_gcd.1.wild_mushroom&dot.fungal_growth.remains<2
actions.kotg_st+=/wrath

actions.pre_cd=use_item,name=spymasters_web,if=variable.cd_condition&(buff.spymasters_report.stack>29|fight_remains<cooldown.ca_inc.duration)
actions.pre_cd+=/do_treacherous_transmitter_task,if=variable.cd_condition|buff.harmony_of_the_grove.up&(buff.spymasters_report.stack>29|!trinket.1.is.spymasters_web|!trinket.2.is.spymasters_web)
actions.pre_cd+=/berserking,if=variable.cd_condition
actions.pre_cd+=/potion,if=variable.cd_condition
actions.pre_cd+=/use_item,slot=trinket1,if=!trinket.1.is.spymasters_web&!trinket.1.is.imperfect_ascendancy_serum&!trinket.1.is.treacherous_transmitter&!trinket.1.is.soulletting_ruby&(variable.on_use_trinket=1|variable.on_use_trinket=3)&variable.cd_condition
actions.pre_cd+=/use_item,slot=trinket2,if=!trinket.2.is.spymasters_web&!trinket.2.is.imperfect_ascendancy_serum&!trinket.2.is.treacherous_transmitter&!trinket.2.is.soulletting_ruby&variable.on_use_trinket=2&variable.cd_condition
actions.pre_cd+=/use_item,name=bestinslots,if=hero_tree.keeper_of_the_grove&buff.harmony_of_the_grove.up|hero_tree.elunes_chosen&(cooldown.ca_inc.full_recharge_time>20|buff.ca_inc.up)

actions.st=warrior_of_elune,if=talent.lunar_calling&!buff.dreamstate.up&(buff.ca_inc.up|cooldown.ca_inc.remains>10|fight_remains<cooldown.ca_inc.remains+5)|!talent.lunar_calling&variable.eclipse_remains<=7
actions.st+=/fury_of_elune,if=(cooldown.ca_inc.remains<?variable.eclipse_remains)<gcd.max|cooldown.ca_inc.remains<fight_remains&fight_remains<(buff.ca_inc.duration+gcd.max>?fight_remains-cooldown.ca_inc.remains)+gcd.max|fight_remains<8+gcd.max
actions.st+=/wrath,if=variable.enter_lunar&eclipse.in_eclipse&variable.eclipse_remains<cast_time&!(cooldown.ca_inc.remains<action.starfire.cast_time)
actions.st+=/starfire,if=(!variable.enter_lunar|cooldown.ca_inc.remains<cast_time)&eclipse.in_eclipse&variable.eclipse_remains<cast_time
actions.st+=/sunfire,target_if=remains<3|refreshable&(hero_tree.keeper_of_the_grove&cooldown.force_of_nature.ready|hero_tree.elunes_chosen&variable.cd_condition)
actions.st+=/moonfire,target_if=remains<3&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up)
actions.st+=/fury_of_elune,if=5+variable.passive_asp<astral_power.deficit&(!(cooldown.ca_inc.remains<variable.eclipse_remains&variable.eclipse_remains<12)|buff.dreamstate.up&cooldown.ca_inc.remains<gcd.max)
actions.st+=/call_action_list,name=pre_cd
actions.st+=/celestial_alignment,if=variable.cd_condition
actions.st+=/incarnation,if=variable.cd_condition&(buff.dreamstate.stack=2|prev_gcd.1.fury_of_elune&buff.dreamstate.up|fight_remains<buff.ca_inc.duration+gcd.max)
actions.st+=/wrath,if=variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)
actions.st+=/starfire,if=!variable.enter_lunar&(eclipse.in_none|variable.eclipse_remains<cast_time)
actions.st+=/starsurge,if=variable.cd_condition&astral_power.deficit>variable.passive_asp+action.force_of_nature.energize_amount
actions.st+=/force_of_nature,if=variable.pre_cd_condition|cooldown.ca_inc.full_recharge_time+5+15*talent.control_of_the_dream>cooldown&(!talent.convoke_the_spirits|cooldown.convoke_the_spirits.remains+10+15*talent.control_of_the_dream>cooldown|fight_remains<cooldown.convoke_the_spirits.remains+cooldown.convoke_the_spirits.duration+5)&(variable.on_use_trinket=0|cooldown.ca_inc.remains>20|talent.convoke_the_spirits&cooldown.convoke_the_spirits.remains>20|(variable.on_use_trinket=1|variable.on_use_trinket=3)&(trinket.1.cooldown.remains>5+15*talent.control_of_the_dream|trinket.1.cooldown.ready)|variable.on_use_trinket=2&(trinket.2.cooldown.remains>5+15*talent.control_of_the_dream|trinket.2.cooldown.ready))&(fight_remains>cooldown+5|fight_remains<cooldown.ca_inc.remains+7)|talent.whirling_stars&talent.convoke_the_spirits&cooldown.convoke_the_spirits.remains>cooldown.force_of_nature.duration-10&fight_remains>cooldown.convoke_the_spirits.remains+6
actions.st+=/starfall,if=buff.starweavers_warp.up
actions.st+=/starsurge,if=talent.starlord&buff.starlord.stack<3
actions.st+=/sunfire,target_if=refreshable
actions.st+=/moonfire,target_if=refreshable&(!talent.treants_of_the_moon|cooldown.force_of_nature.remains>3&!buff.harmony_of_the_grove.up)
actions.st+=/starsurge,if=cooldown.convoke_the_spirits.remains<gcd.max*2&variable.convoke_condition&astral_power.deficit<50
actions.st+=/convoke_the_spirits,if=variable.convoke_condition
actions.st+=/stellar_flare,target_if=refreshable&(target.time_to_die-remains-target>7+spell_targets)
actions.st+=/starsurge,if=buff.starlord.remains>4&variable.boat_stacks>=3|fight_remains<4
actions.st+=/new_moon,if=astral_power.deficit>variable.passive_asp+energize_amount|fight_remains<20|cooldown.ca_inc.remains>15
actions.st+=/half_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)|fight_remains<20|cooldown.ca_inc.remains>15
actions.st+=/full_moon,if=astral_power.deficit>variable.passive_asp+energize_amount&(buff.eclipse_lunar.remains>execute_time|buff.eclipse_solar.remains>execute_time)|fight_remains<20|cooldown.ca_inc.remains>15
actions.st+=/starsurge,if=buff.starweavers_weft.up|buff.touch_the_cosmos.up
actions.st+=/starsurge,if=astral_power.deficit<variable.passive_asp+action.wrath.energize_amount+(action.starfire.energize_amount+variable.passive_asp)*(buff.eclipse_solar.remains<(gcd.max+action.starfire.cast_time))
actions.st+=/force_of_nature,if=!hero_tree.keeper_of_the_grove
actions.st+=/wild_mushroom,if=!prev_gcd.1.wild_mushroom&dot.fungal_growth.remains<2
actions.st+=/starfire,if=talent.lunar_calling
actions.st+=/wrath
